---
- name: Configure local computer
  hosts: pi

  tasks:
    - name: Install FTP
      become: yes
      ansible.builtin.apt:
        name: vsftpd

    - name: Copy FTP configuration
      become: yes
      ansible.builtin.copy:
        src: conf/vsftpd.conf
        dest: /etc/vsftpd.conf
        owner: root
        group: root
        mode: '0644'
      notify:
        - Restart vsftpd

    - name: Install vim
      become: yes
      ansible.builtin.apt:
        name: vim
        state: latest

    - name: Install Openjdk-8
      become: yes
      ansible.builtin.apt:
        name: openjdk-8-jdk
        state: latest
        install_recommends: no

    - name: Download docker
      ansible.builtin.get_url:
        url: https://get.docker.com
        dest: /home/pi/get-docker.sh

    - name: Install docker
      become: yes
      command: sh get-docker.sh
      args:
        chdir: /home/pi

    - name: Add docker group to pi user
      become: yes
      command: "usermod -aG docker pi"

    - name: install docker-compose requirements
      become: yes
      ansible.builtin.apt:
        pkg:
        - libffi-dev
        - libssl-dev
        - python3-dev
        - python3 
        - python3-pip

    - name: Install docker-compose
      become: yes
      command: pip3 install docker-compose
  
    - name: Create app directories
      become: yes
      ansible.builtin.file:
        path: '{{ item.path }}'
        state: directory
      loop:
        - { path: /home/pi/apps/jellyfin/config/ }
        - { path: /home/pi/apps/jellyfin/music/ }
        - { path: /home/pi/apps/nextcloud/ }

    - name: Copy docker-compose 
      ansible.builtin.copy:
        src: conf/docker-compose.yml
        dest: /home/pi/apps

    - name: Install libseccomp2.4.4
      become: yes
      ansible.builtin.apt:
        deb: "http://ftp.us.debian.org/debian/pool/main/libs/libseccomp/libseccomp2_2.4.4-1~bpo10+1_armhf.deb"

  handlers:
    - name: Restart vsftpd
      become: yes
      ansible.builtin.service:
        name: vsftpd 
        state: restarted
